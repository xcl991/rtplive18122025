// ============================================
// ðŸ”¥ FIREBASE MESSAGING SERVICE WORKER
// ============================================
// This service worker handles background push notifications
// File MUST be in the root directory of your website
//
// DO NOT EDIT THIS FILE UNLESS YOU KNOW WHAT YOU'RE DOING
// All configuration is in firebase-config.js

// Import Firebase scripts
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js');

// Load Firebase configuration
// Note: Service workers can't directly access window.FIREBASE_CONFIG
// So we initialize with a basic config and update from main thread
let firebaseConfig = {
    apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    authDomain: "your-project-id.firebaseapp.com",
    projectId: "your-project-id",
    storageBucket: "your-project-id.appspot.com",
    messagingSenderId: "123456789012",
    appId: "1:123456789012:web:abcdef1234567890abcdef"
};

// Listen for config updates from main thread
self.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'FIREBASE_CONFIG') {
        firebaseConfig = event.data.config;
        console.log('ðŸ”¥ Service Worker: Firebase config updated');

        // Reinitialize Firebase with new config
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('âœ… Service Worker: Firebase reinitialized');
        } catch (error) {
            console.error('âŒ Service Worker: Failed to reinitialize Firebase', error);
        }
    }
});

// Initialize Firebase
try {
    firebase.initializeApp(firebaseConfig);
    console.log('ðŸ”¥ Firebase initialized in service worker');
} catch (error) {
    console.error('âŒ Firebase initialization failed in service worker:', error);
}

// Get Firebase Messaging instance
const messaging = firebase.messaging();

// ============================================
// ðŸ“¬ HANDLE BACKGROUND MESSAGES
// ============================================
// This runs when notification is received while app is in background

messaging.onBackgroundMessage((payload) => {
    console.log('ðŸ“¬ Background message received:', payload);

    // Extract notification data
    const notificationTitle = payload.notification?.title || payload.data?.title || 'SULTANPLAY77';
    const notificationOptions = {
        body: payload.notification?.body || payload.data?.body || 'Anda mendapat notifikasi baru!',
        icon: payload.notification?.icon || payload.data?.icon || 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png',
        badge: payload.notification?.badge || payload.data?.badge || 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png',
        image: payload.notification?.image || payload.data?.image || null,
        data: {
            url: payload.notification?.click_action || payload.data?.click_action || payload.data?.url || '/',
            ...payload.data
        },
        tag: payload.data?.tag || 'notification',
        requireInteraction: payload.data?.requireInteraction === 'true' || false,
        vibrate: [200, 100, 200],
        actions: [
            {
                action: 'open',
                title: 'Buka',
                icon: 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png'
            },
            {
                action: 'close',
                title: 'Tutup',
                icon: 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png'
            }
        ]
    };

    // Show notification
    return self.registration.showNotification(notificationTitle, notificationOptions);
});

// ============================================
// ðŸ–±ï¸ HANDLE NOTIFICATION CLICK
// ============================================
// This runs when user clicks on the notification

self.addEventListener('notificationclick', (event) => {
    console.log('ðŸ–±ï¸ Notification clicked:', event.notification.tag);

    event.notification.close();

    // Handle action buttons
    if (event.action === 'close') {
        console.log('User closed notification');
        return;
    }

    // Get URL from notification data
    const urlToOpen = event.notification.data?.url || '/';
    const fullUrl = new URL(urlToOpen, self.location.origin).href;

    // Open or focus window
    event.waitUntil(
        clients.matchAll({ type: 'window', includeUncontrolled: true }).then((clientList) => {
            // Check if there's already a window open
            for (const client of clientList) {
                if (client.url === fullUrl && 'focus' in client) {
                    return client.focus();
                }
            }

            // If no window is open, open a new one
            if (clients.openWindow) {
                return clients.openWindow(fullUrl);
            }
        })
    );

    // Track click event
    try {
        fetch('/api/track-notification-click', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tag: event.notification.tag,
                action: event.action || 'open',
                timestamp: new Date().toISOString()
            })
        }).catch(() => {
            // Silently fail if tracking endpoint doesn't exist
        });
    } catch (error) {
        // Ignore tracking errors
    }
});

// ============================================
// ðŸ”” HANDLE NOTIFICATION CLOSE
// ============================================

self.addEventListener('notificationclose', (event) => {
    console.log('ðŸ”• Notification closed:', event.notification.tag);

    // Track close event (optional)
    try {
        fetch('/api/track-notification-close', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                tag: event.notification.tag,
                timestamp: new Date().toISOString()
            })
        }).catch(() => {
            // Silently fail if tracking endpoint doesn't exist
        });
    } catch (error) {
        // Ignore tracking errors
    }
});

// ============================================
// âš™ï¸ SERVICE WORKER LIFECYCLE
// ============================================

// Install event
self.addEventListener('install', (event) => {
    console.log('ðŸ”§ Service Worker: Installing...');
    self.skipWaiting(); // Activate immediately
});

// Activate event
self.addEventListener('activate', (event) => {
    console.log('âœ… Service Worker: Activated');
    event.waitUntil(clients.claim()); // Take control of all pages
});

// Push event (backup handler)
self.addEventListener('push', (event) => {
    console.log('ðŸ“¨ Push event received');

    if (!event.data) {
        console.warn('Push event has no data');
        return;
    }

    try {
        const data = event.data.json();
        console.log('Push data:', data);

        const title = data.notification?.title || data.title || 'SULTANPLAY77';
        const options = {
            body: data.notification?.body || data.body || 'Notifikasi baru',
            icon: data.notification?.icon || data.icon || 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png',
            badge: data.notification?.badge || data.badge || 'https://i.ibb.co/FLSpqT3Q/3-SULTANPLAY.png',
            data: data.data || {},
            tag: data.tag || 'default',
            vibrate: [200, 100, 200]
        };

        event.waitUntil(
            self.registration.showNotification(title, options)
        );
    } catch (error) {
        console.error('Error handling push event:', error);
    }
});

console.log('ðŸ”¥ Firebase Messaging Service Worker loaded');
